<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng Truyện - Coconut Manga</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:15px}
    .box{max-width:600px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
    h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0;font-size:24px}
    .form{padding:20px}
    input[type=text], input[type=file], textarea{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px}
    textarea{height:100px;resize:vertical}
    .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:30px;text-align:center;border-radius:12px;margin:10px 0;cursor:pointer;font-size:16px}
    .drop:hover{background:#ffe5e5}
    button{width:100%;padding:15px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:18px;margin-top:10px;cursor:pointer;font-weight:bold}
    .progress{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
    .bar{height:100%;width:0;background:#e74c3c;transition:width .4s}
    #status{text-align:center;padding:10px;font-weight:bold;font-size:16px}
    label{font-weight:bold;margin-top:10px;display:block}
  </style>
</head>
<body>
  <div class="box">
    <h1>ĐĂNG/CẬP NHẬT TRUYỆN</h1>
    <div class="form">
      <input type="text" id="id" placeholder="ID truyện (bắt buộc)" required>
      <div id="newStoryFields">
        <input type="text" id="title" placeholder="Tên truyện (bắt buộc nếu truyện mới)">
        <input type="text" id="author" placeholder="Tác giả">
        <textarea id="description" placeholder="Tóm tắt truyện"></textarea>
        <label>Bìa truyện (file hoặc URL)</label>
        <input type="file" id="coverFile" accept="image/*">
        <input type="text" id="coverUrl" placeholder="Hoặc nhập URL bìa">
      </div>

      <label>Chapter mới</label>
      <input type="text" id="chapName" placeholder="Tên chapter (Chapter 1)">
      <div class="drop" id="dropZone">Kéo thả ảnh chapter hoặc nhập URL, mỗi URL 1 dòng</div>
      <input type="file" id="chapterImages" multiple accept="image/*" style="display:none">
      <textarea id="chapterUrls" placeholder="Hoặc nhập URL các trang, mỗi URL 1 dòng" style="height:100px"></textarea>

      <button onclick="uploadAll()">GỬI TRUYỆN NGAY</button>
      <div class="progress"><div class="bar" id="progressBar"></div></div>
      <div id="status">Sẵn sàng</div>
    </div>
  </div>

<script>
let token = localStorage.getItem("gh_token");
if (!token || !token.startsWith("ghp_")) {
  token = prompt("Nhập GitHub Token (ghp_...) – chỉ hiện 1 lần:");
  if (token && token.startsWith("ghp_")) localStorage.setItem("gh_token", token);
  else { alert("Token sai!"); throw new Error("No token"); }
}

const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
const RAW = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

// Drag & drop
const dropZone = document.getElementById("dropZone");
dropZone.addEventListener("click", () => document.getElementById("chapterImages").click());
dropZone.addEventListener("dragover", e => e.preventDefault());
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  document.getElementById("chapterImages").files = files;
  dropZone.innerHTML = `<b>Đã chọn ${files.length} ảnh chapter</b>`;
});
document.getElementById("chapterImages").addEventListener("change", () => {
  const files = document.getElementById("chapterImages").files;
  dropZone.innerHTML = `<b>Đã chọn ${files.length} ảnh chapter</b>`;
});

async function uploadFile(path, fileOrBlob) {
  return new Promise((resolve, reject) => {
    if (typeof fileOrBlob === "string") return resolve(fileOrBlob); // URL
    const reader = new FileReader();
    reader.onload = async () => {
      const base64 = reader.result.split(',')[1];
      const payload = { message: "upload truyện", content: base64, branch: "main" };
      try {
        const res = await fetch(API + "/" + path, { headers: { Authorization: "token " + token } });
        if (res.ok) payload.sha = (await res.json()).sha;
      } catch(e) {}
      const putRes = await fetch(API + "/" + path, {
        method: "PUT",
        headers: { Authorization: "token " + token, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (putRes.ok) resolve(RAW + "/" + path);
      else reject("Upload thất bại: " + path);
    };
    reader.onerror = () => reject("Lỗi đọc file: " + path);
    if (fileOrBlob instanceof Blob) reader.readAsDataURL(fileOrBlob);
  });
}

async function uploadAll() {
  const status = document.getElementById("status");
  const bar = document.getElementById("progressBar");
  try {
    status.textContent = "Đang kiểm tra truyện...";
    bar.style.width = "5%";

    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    if (!id) throw "Nhập ID truyện";
    const chapName = document.getElementById("chapName").value || "Chapter mới";

    const storiesRes = await fetch(RAW + "/stories.json?t=" + Date.now());
    const stories = storiesRes.ok ? await storiesRes.json() : [];

    let story = stories.find(s => s.id === id);
    let isNew = !story;

    // Nếu truyện mới
    let title = document.getElementById("title").value.trim();
    let author = document.getElementById("author").value.trim() || "Không rõ";
    let description = document.getElementById("description").value.trim() || "Chưa có tóm tắt";
    let coverFile = document.getElementById("coverFile").files[0];
    let coverUrl = document.getElementById("coverUrl").value.trim();

    if (isNew) {
      if (!title) throw "Truyện mới cần tên";
      if (!coverFile && !coverUrl) throw "Truyện mới cần bìa";
      coverUrl = await uploadFile(`images/${id}_cover.jpg`, coverFile || coverUrl);
      story = { id, title, author, description, thumbnail: coverUrl, chapters: [] };
      stories.push(story);
    }

    // Upload chapter
    const files = document.getElementById("chapterImages").files;
    const urlsText = document.getElementById("chapterUrls").value.trim();
    let imageUrls = urlsText ? urlsText.split("\n").map(u=>u.trim()).filter(u=>u) : [];
    for (let i = 0; i < files.length; i++) {
      imageUrls.push(await uploadFile(`images/${id}_p${story.chapters.length*100+i+1}.jpg`, files[i]));
    }

    if (!imageUrls.length) throw "Chưa có ảnh cho chapter mới";

    story.chapters.push({ name: chapName, images: imageUrls });

    const jsonBlob = new Blob([JSON.stringify(stories, null, 2)], { type: "application/json" });
    await uploadFile("stories.json", jsonBlob);

    bar.style.width = "100%";
    status.innerHTML = `<b style='color:green'>Hoàn tất! Chapter mới đã được thêm.</b>`;
  } catch(e) {
    status.innerHTML = `<b style='color:red'>Lỗi: ${e}</b>`;
    bar.style.width = "0%";
  }
}
</script>
</body>
</html>
