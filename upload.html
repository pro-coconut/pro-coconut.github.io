<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Truyện - Coconut Manga</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #e74c3c; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #e74c3c; color: white; border: none; cursor: pointer; font-size: 16px; }
        .drop { border: 2px dashed #e74c3c; padding: 30px; text-align: center; margin: 10px 0; cursor: pointer; }
        #progress { height: 10px; background: #ddd; margin: 10px 0; }
        #bar { height: 100%; background: #e74c3c; width: 0%; transition: width 0.3s; }
        #status { text-align: center; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Đăng Truyện Mới</h1>
        <input type="text" id="title" placeholder="Tên truyện *" required>
        <input type="text" id="id" placeholder="ID (không dấu, vd: tavodich)" required>
        <input type="text" id="author" placeholder="Tác giả (tùy chọn)">
        <input type="file" id="cover" accept="image/*" required>
        <input type="text" id="chap" value="Chapter 1">
        <div class="drop" id="drop">Kéo thả ảnh chapter hoặc nhấn chọn</div>
        <input type="file" id="images" multiple accept="image/*" style="display:none">
        <button onclick="uploadStory()">Gửi Truyện</button>
        <div id="progress"><div id="bar"></div></div>
        <div id="status">Sẵn sàng!</div>
    </div>

    <script>
        // Token
        let token = localStorage.getItem('token');
        if (!token) {
            token = prompt('Nhập GitHub Token (ghp_...)');
            if (token && token.startsWith('ghp_')) localStorage.setItem('token', token);
            else { alert('Token sai!'); return; }
        }

        const repo = 'pro-coconut/pro-coconut.github.io';
        const api = `https://api.github.com/repos/${repo}/contents`;

        function updateStatus(msg, progress = 0) {
            document.getElementById('status').textContent = msg;
            document.getElementById('bar').style.width = progress + '%';
        }

        async function getSha(path) {
            try {
                const res = await fetch(`${api}/${path}?ref=main`, { headers: { 'Authorization': `token ${token}` } });
                if (res.ok) return (await res.json()).sha;
            } catch (e) {}
            return null;
        }

        async function uploadFile(path, file) {
            const bytes = await file.arrayBuffer();
            const content = btoa(String.fromCharCode(...new Uint8Array(bytes)));
            const sha = await getSha(path);
            const body = { message: 'Upload manga', content, branch: 'main' };
            if (sha) body.sha = sha;
            const res = await fetch(`${api}/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error('Upload fail');
            return `https://raw.githubusercontent.com/${repo}/main/${path}`;
        }

        async function getStories() {
            try {
                const res = await fetch(`https://raw.githubusercontent.com/${repo}/main/stories.json`);
                return res.ok ? await res.json() : [];
            } catch (e) { return []; }
        }

        async function saveStories(stories) {
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(stories, null, 2))));
            const sha = await getSha('stories.json');
            const body = { message: 'Update stories', content, branch: 'main' };
            if (sha) body.sha = sha;
            await fetch(`${api}/stories.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        async function uploadStory() {
            try {
                updateStatus('Bắt đầu...', 0);
                const title = document.getElementById('title').value.trim();
                const id = document.getElementById('id').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!title || !id) throw new Error('Nhập tên và ID');
                const coverFile = document.getElementById('cover').files[0];
                const imageFiles = document.getElementById('images').files;
                if (!coverFile) throw new Error('Chọn ảnh bìa');
                if (imageFiles.length === 0) throw new Error('Chọn ảnh chapter');

                updateStatus('Upload bìa...', 20);
                const coverUrl = await uploadFile(`images/${id}_cover.jpg`, coverFile);

                updateStatus('Upload chapter...', 30);
                const urls = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    urls.push(await uploadFile(`images/${id}_page_${i + 1}.jpg`, imageFiles[i]));
                    updateStatus(`Trang ${i + 1}/${imageFiles.length}`, 30 + (i + 1) / imageFiles.length * 50);
                }

                updateStatus('Cập nhật danh sách...', 90);
                const stories = await getStories();
                const existing = stories.find(s => s.id === id);
                const chapter = { name: document.getElementById('chap').value, images: urls };
                if (existing) {
                    existing.chapters.push(chapter);
                } else {
                    stories.push({
                        id, title, author: document.getElementById('author').value || 'Không rõ',
                        thumbnail: coverUrl, chapters: [chapter]
                    });
                }
                await saveStories(stories);

                updateStatus('Hoàn tất! Reload trang chủ để xem.', 100);
            } catch (error) {
                updateStatus('Lỗi: ' + error.message, 0);
            }
        }

        // Drag & drop
        const drop = document.getElementById('drop');
        drop.addEventListener('click', () => document.getElementById('images').click());
        drop.addEventListener('dragover', e => e.preventDefault());
        drop.addEventListener('drop', e => {
            e.preventDefault();
            document.getElementById('images').files = e.dataTransfer.files;
            drop.textContent = `Đã chọn ${e.dataTransfer.files.length} ảnh`;
        });
    </script>
</body>
</html>
