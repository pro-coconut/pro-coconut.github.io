<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>
<style>
  body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:15px}
  .box{max-width:560px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
  h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0;font-size:24px}
  .form{padding:20px}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;border-radius:8px;box-sizing:border-box;font-size:16px}
  input,textarea{border:1px solid #ddd}
  button{background:#e74c3c;color:#fff;border:none;cursor:pointer;font-weight:bold}
  .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:40px;text-align:center;border-radius:12px;cursor:pointer;font-size:16px}
  .drop:hover{background:#ffe5e5}
  .bar{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
  .fill{height:100%;width:0;background:#e74c3c;transition:width .4s}
  #status{text-align:center;padding:10px;font-weight:bold;font-size:16px}
</style>
</head>
<body>
<div class="box">
  <h1>ĐĂNG TRUYỆN MỚI</h1>
  <div class="form">
    <input type="text" id="title" placeholder="Tên truyện (bắt buộc)" required>
    <input type="text" id="id" placeholder="ID (không dấu, vd: tavodich)" required>
    <input type="text" id="author" placeholder="Tác giả">
    <textarea id="description" placeholder="Tóm tắt truyện (hiện ở trang chi tiết)"></textarea>
    <input type="file" id="cover" accept="image/*" required>
    <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
    <div class="drop" id="drop">Kéo thả hoặc nhấn để chọn nhiều ảnh chapter</div>
    <input type="file" id="imgs" multiple accept="image/*" style="display:none">
    <button onclick="start()">GỬI TRUYỆN NGAY</button>
    <div class="bar"><div class="fill" id="fill"></div></div>
    <div id="status">Sẵn sàng</div>
  </div>
</div>

<script>
// Token
let token = localStorage.getItem("t") || prompt("Nhập GitHub Token (ghp_...)");
if(token && token.startsWith("ghp_")) localStorage.setItem("t", token);
else { alert("Token sai!"); throw""; }

const api = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
const raw = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

// Upload từng ảnh riêng biệt – không tích luỹ dữ liệu → không bao giờ lỗi call stack
async function uploadSingle(path, file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async e => {
      const base64 = e.target.result.split(',')[1];
      const payload = {message:"upload",content:base64,branch:"main"};
      try{
        const r = await fetch(api+"/"+path,{headers:{Authorization:"token "+token}});
        if(r.ok) payload.sha = (await r.json()).sha;
      }catch(e){}
      const res = await fetch(api+"/"+path,{method:"PUT",headers:{Authorization:"token "+token,"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(res.ok) resolve(raw+"/"+path);
      else reject("Upload fail");
    };
    reader.readAsDataURL(file);
  });
}

document.getElementById("drop").onclick = () => document.getElementById("imgs").click();
document.getElementById("drop").ondrop = e => {e.preventDefault(); document.getElementById("imgs").files = e.dataTransfer.files; show();};
document.getElementById("imgs").onchange = show;
function show(){document.getElementById("drop").innerHTML=`Đã chọn <b>${document.getElementById("imgs").files.length}</b> ảnh`;}

async function start(){
  const s = document.getElementById("status");
  const f = document.getElementById("fill");
  try{
    s.textContent="Bắt đầu..."; f.style.width="5%";
    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    if(!id || !document.getElementById("title").value) throw "Nhập tên + ID";

    // Bìa
    s.textContent="Upload bìa..."; f.style.width="15%";
    const cover = await uploadSingle("images/"+id+"_cover.jpg", document.getElementById("cover").files[0]);

    // Chapter – vẫn chọn nhiều ảnh bình thường
    const files = document.getElementById("imgs").files;
    const urls = [];
    for(let i=0; i<files.length; i++){
      s.textContent=`Upload ${i+1}/${files.length}...`;
      urls.push(await uploadSingle("images/"+id+"_p"+(i+1)+".jpg", files[i]));
      f.style.width = 15 + 80*(i+1)/files.length + "%";
    }

    // stories.json
    s.textContent="Cập nhật danh sách..."; f.style.width="98%";
    const stories = await fetch(raw+"/stories.json?t="+Date.now()).then(r=>r.ok?r.json():[]);
    const ex = stories.find(x=>x.id===id);
    const chap = {name:document.getElementById("chap").value||Chap mới,images:urls};
    if(ex){
      ex.chapters.push(chap);
      if(document.getElementById("description").value) ex.description = document.getElementById("description").value;
    }else{
      stories.push({
        id, title:document.getElementById("title").value,
        author:document.getElementById("author").value||"Không rõ",
        description:document.getElementById("description").value||"Chưa có tóm tắt",
        thumbnail:cover, chapters:[chap]
      });
    }
    const json64 = btoa(unescape(encodeURIComponent(JSON.stringify(stories,null,2))));
    await uploadSingle("stories.json", new Blob([JSON.stringify(stories,null,2)], {type:"application/json"}));

    f.style.width="100%";
    s.innerHTML="<b style='color:green'>HOÀN TẤT 100%!<br>Reload trang chủ là thấy!</b>";
  }catch(e){
    s.innerHTML="<b style='color:red'>LỖI: "+e+"</b>";
    f.style.width="0%";
  }
}
</script>
</body>
</html>
