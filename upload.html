<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>
<style>
  body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:15px}
  .box{max-width:560px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
  h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0;font-size:24px}
  .form{padding:20px}
  input[type=text],input[type=file],textarea{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px}
  textarea{height:100px;resize:vertical}
  .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:40px;text-align:center;border-radius:12px;margin:15px 0;cursor:pointer;font-size:16px}
  .drop:hover{background:#ffe5e5}
  button{width:100%;padding:15px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:18px;margin-top:10px;cursor:pointer}
  .progress{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
  .bar{height:100%;width:0;background:#e74c3c;transition:all .4s}
  #status{text-align:center;padding:10px;font-weight:bold;font-size:16px}
</style>
</head>
<body>
<div class="box">
  <h1>ĐĂNG TRUYỆN MỚI</h1>
  <div class="form">
    <input type="text" id="title" placeholder="Tên truyện (bắt buộc)" required>
    <input type="text" id="id" placeholder="ID (không dấu, vd: tavodich)" required>
    <input type="text" id="author" placeholder="Tác giả (không bắt buộc)">
    <textarea id="description" placeholder="Tóm tắt truyện (hiện ở trang chi tiết)"></textarea>
    <input type="file" id="cover" accept="image/*" required>
    <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
    <div class="drop" id="dropZone">Kéo thả ảnh chapter vào đây<br>hoặc nhấn để chọn nhiều ảnh</div>
    <input type="file" id="chapterImages" multiple accept="image/*" style="display:none">
    <button onclick="upload()">GỬI TRUYỆN NGAY</button>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div id="status">Sẵn sàng – ảnh sẽ tự động nén nhẹ</div>
  </div>
</div>

<script>
// Token
let token = localStorage.getItem("gh_token") || prompt("Nhập GitHub Token (ghp_...)");
if(token && token.startsWith("ghp_")) localStorage.setItem("gh_token", token);
else { alert("Token sai!"); throw""; }

const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
const RAW = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

// Nén ảnh siêu nhẹ
async function compress(file){
  return new Promise(res=>{
    const img = new Image();
    img.onload=()=>{
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d');
      const max=1100;
      if(img.width>max){c.width=max;c.height=img.height*(max/img.width)}else{c.width=img.width;c.height=img.height}
      ctx.drawImage(img,0,0,c.width,c.height);
      c.toBlob(blob=>res(new File([blob],file.name,{type:'image/jpeg'})), 'image/jpeg', 0.8);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function put(path,file){
  const f=await compress(file);
  const b64=btoa(String.fromCharCode(...new Uint8Array(await f.arrayBuffer())));
  const payload={message:"upload",content:b64,branch:"main"};
  try{const r=await fetch(API+"/"+path,{headers:{Authorization:"token "+token}});if(r.ok)payload.sha=(await r.json()).sha}catch(e){}
  const res=await fetch(API+"/"+path,{method:"PUT",headers:{Authorization:"token "+token,"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(!res.ok) throw "Upload fail";
  return RAW+"/"+path;
}

async function getStories(){const r=await fetch(RAW+"/stories.json?t="+Date.now());return r.ok?await r.json():[]}
async function saveStories(d){
  const b64=btoa(unescape(encodeURIComponent(JSON.stringify(d,null,2))));
  const payload={message:"update",content:b64,branch:"main"};
  try{const r=await fetch(API+"/stories.json",{headers:{Authorization:"token "+token}});if(r.ok)payload.sha=(await r.json()).sha}catch(e){}
  await fetch(API+"/stories.json",{method:"PUT",headers:{Authorization:"token "+token,"Content-Type":"application/json"},body:JSON.stringify(payload)});
}

async function upload(){
  const s=document.getElementById("status"),b=document.getElementById("progressBar");
  try{
    s.textContent="Đang xử lý...";b.style.width="5%";
    const id=document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    const title=document.getElementById("title").value.trim();
    const desc=document.getElementById("description").value.trim();
    if(!title||!id)throw"Nhập tên + ID";
    if(!document.getElementById("cover").files[0])throw"Chọn ảnh bìa";
    if(!document.getElementById("chapterImages").files.length)throw"Chọn ảnh chapter";

    const cover=await put("images/"+id+"_cover.jpg",document.getElementById("cover").files[0]);
    s.textContent="Upload bìa xong";b.style.width="25%";

    const files=document.getElementById("chapterImages").files;
    const urls=[];
    for(let i=0;i<files.length;i++){
      s.textContent=`Nén & upload ${i+1}/${files.length}...`;
      urls.push(await put("images/"+id+"_p"+(i+1)+".jpg",files[i]));
      b.style.width=25+70*(i+1)/files.length+"%";
    }

    s.textContent="Cập nhật danh sách...";b.style.width="95%";
    const list=await getStories();
    const exist=list.find(x=>x.id===id);
    const chap={name:document.getElementById("chap").value||"Chapter mới",images:urls};
    if(exist){
      exist.chapters.push(chap);
      if(desc)exist.description=desc;
    }else{
      list.push({id,title,author:document.getElementById("author").value||"Không rõ",description:desc||"Chưa có tóm tắt",thumbnail:cover,chapters:[chap]});
    }
    await saveStories(list);

    b.style.width="100%";
    s.innerHTML="<b style='color:green'>HOÀN TẤT 100%!<br>Reload trang chủ là thấy truyện!</b>";
  }catch(e){
    s.innerHTML="<b style='color:red'>LỖI: "+e+"</b>";
    b.style.width="0%";
  }
}

// Drag & drop + chọn ảnh (đã fix 100%)
const drop=document.getElementById("dropZone");
drop.onclick=()=>document.getElementById("chapterImages").click();
drop.ondragover=e=>e.preventDefault();
drop.ondrop=e=>{
  e.preventDefault();
  document.getElementById("chapterImages").files=e.dataTransfer.files;
  drop.innerHTML=`Đã chọn <b>${e.dataTransfer.files.length}</b> ảnh`;
};
document.getElementById("chapterImages").onchange=()=>{
  const c=document.getElementById("chapterImages").files.length;
  drop.innerHTML=c?`Đã chọn <b>${c}</b> ảnh`:"Kéo thả ảnh chapter vào đây";
};
</script>
</body>
</html>
