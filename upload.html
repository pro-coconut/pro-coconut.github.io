<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ƒêƒÉng Truy·ªán - Coconut Manga</title>
<style>
  body{font-family:Arial;background:#f0f0f0;padding:15px;margin:0}
  .box{max-width:600px;margin:20px auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1)}
  h1{text-align:center;color:#e74c3c;margin:0 0 20px}
  input,button{padding:12px;margin:8px 0;width:100%;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  button{background:#e74c3c;color:#fff;font-size:18px;cursor:pointer}
  .drop{border:3px dashed #e74c3c;padding:40px;text-align:center;border-radius:12px;margin:15px 0;background:#fff9}
  #bar{height:20px;background:#ddd;border-radius:10px;overflow:hidden;margin:15px 0}
  #fill{height:100%;width:0;background:#e74c3c;transition:width .4s}
  #log{font-weight:bold;text-align:center;color:#e74c3c;margin:10px 0}
</style>
</head>
<body>
<div class="box">
  <h1>ƒêƒÇNG TRUY·ªÜN</h1>
  <input type="text" id="title" placeholder="T√™n truy·ªán (b·∫Øt bu·ªôc)" required>
  <input type="text" id="id" placeholder="ID truy·ªán (kh√¥ng d·∫•u, v√≠ d·ª•: onepiece)" required>
  <input type="text" id="author" placeholder="T√°c gi·∫£ (kh√¥ng b·∫Øt bu·ªôc)">
  <input type="file" id="cover" accept="image/*" required>
  <input type="text" id="chap" placeholder="T√™n chapter" value="Chapter 1">
  <div class="drop" id="drop">K√©o th·∫£ ·∫£nh chapter v√†o ƒë√¢y<br>ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</div>
  <input type="file" id="imgs" multiple accept="image/*" style="display:none">
  <button onclick="start()">G·ª¨I TRUY·ªÜN NGAY</button>
  <div id="bar"><div id="fill"></div></div>
  <div id="log">S·∫µn s√†ng</div>
</div>

<script>
let TOKEN = localStorage.getItem("gh_token");
if (!TOKEN) {
  TOKEN = prompt("Nh·∫≠p GitHub Token (ghp_...) ‚Äì ch·ªâ hi·ªán 1 l·∫ßn:");
  if (TOKEN && TOKEN.startsWith("ghp_")) localStorage.setItem("gh_token", TOKEN);
  else { alert("Token sai!"); throw ""; }
}
const REPO = "pro-coconut/pro-coconut.github.io";
const API = "https://api.github.com/repos/"+REPO+"/contents";

async function up(p,f){if(f.size>8e6)throw"·∫¢nh qu√° l·ªõn (>8MB)";const a=await f.arrayBuffer();const b=btoa(String.fromCharCode(...new Uint8Array(a)));const s=await fetch(API+"/"+p,{headers:{Authorization:"token "+TOKEN}}).then(r=>r.ok?r.json().then(j=>j.sha):null);const r=await fetch(API+"/"+p,{method:"PUT",headers:{Authorization:"token "+TOKEN},body:JSON.stringify({message:"upload",content:b,branch:"main",sha:s})});if(!r.ok)throw await r.text();return "https://raw.githubusercontent.com/"+REPO+"/main/"+p}
async function getS(){try{const r=await fetch("https://raw.githubusercontent.com/"+REPO+"/main/stories.json?"+Date.now());return r.status===404?[]:await r.json()}catch{return[]}}
async function putS(d){const s=await fetch(API+"/stories.json",{headers:{Authorization:"token "+TOKEN}}).then(r=>r.ok?r.json().then(j=>j.sha):null);await fetch(API+"/stories.json",{method:"PUT",headers:{Authorization:"token "+TOKEN,"Content-Type":"application/json"},body:JSON.stringify({message:"update stories.json",content:btoa(unescape(encodeURIComponent(JSON.stringify(d,null,2)))),branch:"main",sha:s})})}
async function start(){
  const log=document.getElementById("log"),fill=document.getElementById("fill");
  try {
    log.textContent="ƒêang x·ª≠ l√Ω..."; fill.style.width="5%";
    const id=document.getElementById("id").value.trim().toLowerCase();
    const title=document.getElementById("title").value.trim();
    if(!id||!title)throw"Nh·∫≠p ƒë·ªß t√™n truy·ªán v√† ID!";
    if(!document.getElementById("cover").files[0])throw"Ch·ªçn ·∫£nh b√¨a!";
    if(!document.getElementById("imgs").files.length)throw"Ch·ªçn ·∫£nh chapter!";
    log.textContent="Upload ·∫£nh b√¨a..."; fill.style.width="20%";
    const cover=await up("images/"+id+"_cover.jpg",document.getElementById("cover").files[0]);
    const files=document.getElementById("imgs").files;
    const chap=document.getElementById("chap").value;
    const urls=[];
    for(let i=0;i<files.length;i++){
      log.textContent=`Upload ·∫£nh ${i+1}/${files.length}...`;
      urls.push(await up("images/"+id+"_"+(i+1)+".jpg",files[i]));
      fill.style.width=20+70*(i+1)/files.length+"%";
    }
    log.textContent="C·∫≠p nh·∫≠t danh s√°ch..."; fill.style.width="95%";
    const list=await getS();
    const ex=list.findIndex(x=>x.id===id);
    const ch={name:chap,images:urls};
    if(ex>=0) list[ex].chapters.push(ch);
    else list.push({id,title,author:document.getElementById("author").value||"Kh√¥ng r√µ",thumbnail:cover,chapters:[ch]});
    await putS(list);
    fill.style.width="100%";
    log.innerHTML="<b style='color:green'>HO√ÄN T·∫§T! üéâ<br>Reload trang ch·ªß l√† th·∫•y truy·ªán m·ªõi!</b>";
  } catch(e) {
    log.innerHTML="<b style='color:red'>L·ªñI: "+e+"</b>";
    fill.style.width="0%";
  }
}
document.getElementById("drop").onclick=()=>document.getElementById("imgs").click();
document.getElementById("drop").ondrop=e=>{e.preventDefault();document.getElementById("imgs").files=e.dataTransfer.files;document.getElementById("drop").innerHTML="ƒê√£ ch·ªçn <b>"+e.dataTransfer.files.length+"</b> ·∫£nh";}
document.getElementById("drop").ondragover=e=>e.preventDefault();
</script>
</body>
</html>
