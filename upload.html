<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng Truyện - Coconut Manga</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:15px}
    .box{max-width:560px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
    h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0;font-size:24px}
    .form{padding:20px}
    input[type=text],input[type=file]{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
    .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:40px;text-align:center;border-radius:12px;margin:15px 0;cursor:pointer;font-size:16px}
    .drop:hover{background:#ffe5e5}
    button{width:100%;padding:15px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:18px;margin-top:10px;cursor:pointer}
    .progress{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
    .bar{height:100%;width:0;background:#e74c3c;transition:all .4s}
    #status{text-align:center;padding:10px;font-weight:bold;font-size:16px}
  </style>
</head>
<body>
  <div class="box">
    <h1>ĐĂNG TRUYỆN MỚI</h1>
    <div class="form">
      <input type="text" id="title" placeholder="Tên truyện (bắt buộc)" required=""> <input type="text" id="id" placeholder="ID truyện (không dấu, ví dụ: tavodich)" required=""> <input type="text" id="author" placeholder="Tác giả (không bắt buộc)"> <input type="file" id="cover" accept="image/*" required=""> <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
      <div class="drop" id="dropZone">
        Kéo thả ảnh chapter vào đây<br>
        hoặc nhấn để chọn nhiều ảnh
      </div><input type="file" id="chapterImages" multiple accept="image/*" style="display:none"> <button onclick="upload()">GỬI TRUYỆN NGAY</button>
      <div class="progress">
        <div class="bar" id="progressBar"></div>
      </div>
      <div id="status">
        Sẵn sàng đăng truyện
      </div>
    </div>
  </div>
  <script>
  // Token
  let token = localStorage.getItem("gh_token");
  if (!token || !token.startsWith("ghp_")) {
    token = prompt("Nhập GitHub Token (ghp_...) – chỉ hiện 1 lần:");
    if (token && token.startsWith("ghp_")) localStorage.setItem("gh_token", token);
    else { alert("Token sai!"); throw ""; }
  }
  const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
  const RAW = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

  // Upload file
  async function put(path, file) {
    const data = await file.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(data)));
    const payload = { message: "upload", content: b64, branch: "main" };
    try {
        const r = await fetch(API + "/" + path, { headers: { Authorization: "token " + token } });
        if (r.ok) payload.sha = (await r.json()).sha;
    } catch(e) {}
    const res = await fetch(API + "/" + path, {
        method: "PUT",
        headers: { Authorization: "token " + token, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
    if (!res.ok) throw "Upload thất bại";
    return RAW + "/" + path;
  }

  // stories.json
  async function getStories() {
    const r = await fetch(RAW + "/stories.json?t=" + Date.now());
    return r.ok ? await r.json() : [];
  }
  async function saveStories(data) {
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const payload = { message: "update stories", content: b64, branch: "main" };
    try {
        const r = await fetch(API + "/stories.json", { headers: { Authorization: "token " + token } });
        if (r.ok) payload.sha = (await r.json()).sha;
    } catch(e) {}
    await fetch(API + "/stories.json", { method: "PUT", headers: { Authorization: "token " + token, "Content-Type": "application/json" }, body: JSON.stringify(payload) });
  }

  // Main
  async function upload() {
    const status = document.getElementById("status");
    const bar = document.getElementById("progressBar");
    try {
        status.textContent = "Đang chuẩn bị..."; bar.style.width = "5%";
        const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
        const title = document.getElementById("title").value.trim();
        if (!title || !id) throw "Nhập tên truyện và ID!";
        if (!document.getElementById("cover").files[0]) throw "Chọn ảnh bìa!";
        if (!document.getElementById("chapterImages").files.length) throw "Chọn ảnh chapter!";

        // Bìa
        status.textContent = "Đang upload ảnh bìa..."; bar.style.width = "25%";
        const cover = await put("images/"+id+"_cover.jpg", document.getElementById("cover").files[0]);

        // Chapter
        const files = document.getElementById("chapterImages").files;
        const urls = [];
        for(let i=0; i<files.length; i++){
            status.textContent = `Upload trang ${i+1}/${files.length}...`;
            urls.push(await put("images/"+id+"_p"+(i+1)+".jpg", files[i]));
            bar.style.width = 25 + 65*(i+1)/files.length + "%";
        }

        // Lưu stories.json
        status.textContent = "Cập nhật danh sách truyện..."; bar.style.width = "95%";
        const list = await getStories();
        const exist = list.find(x=>x.id===id);
        const chapData = { name: document.getElementById("chap").value, images: urls };
        if(exist) exist.chapters.push(chapData);
        else list.push({id, title, author: document.getElementById("author").value||"Không rõ", thumbnail: cover, chapters: [chapData]});
        await saveStories(list);

        bar.style.width = "100%";
        status.innerHTML = "<b style='color:green'>HOÀN TẤT 100%!<br>Reload trang chủ là thấy truyện mới ngay!</b>";
    } catch(e) {
        status.innerHTML = "<b style='color:red'>LỖI: "+e+"</b>";
        bar.style.width = "0%";
    }
  }

  // Drag & drop + chọn file
  const dropZone = document.getElementById("dropZone");
  dropZone.onclick = () => document.getElementById("chapterImages").click();
  dropZone.ondragover = e => e.preventDefault();
  dropZone.ondrop = e => {
    e.preventDefault();
    document.getElementById("chapterImages").files = e.dataTransfer.files;
    dropZone.innerHTML = `<b>Đã chọn ${e.dataTransfer.files.length} ảnh chapter</b><br>Sẵn sàng đăng!`;
  };
  document.getElementById("chapterImages").onchange = () => {
    const c = document.getElementById("chapterImages").files.length;
    if(c>0) dropZone.innerHTML = `<b>Đã chọn ${c} ảnh chapter</b><br>Sẵn sàng đăng!`;
  };
  </script>
</body>
</html>
