<script>
// Token được lưu trong trình duyệt, không lộ trên GitHub
let TOKEN = localStorage.getItem("gh_token");
if (!TOKEN) {
  TOKEN = prompt("Nhập GitHub Token (ghp_...) – chỉ hiện 1 lần:");
  if (TOKEN && TOKEN.startsWith("ghp_")) localStorage.setItem("gh_token", TOKEN);
  else { alert("Token sai!"); throw "Stop"; }
}

const REPO = "pro-coconut/pro-coconut.github.io";
const API = "https://api.github.com/repos/" + REPO + "/contents";

async function put(path, content) {
  try {
    const sha = await getSha(path);
    const res = await fetch(API + "/" + path, {
      method: "PUT",
      headers: {Authorization: "token " + TOKEN, "Content-Type": "application/json"},
      body: JSON.stringify({
        message: "upload",
        content: btoa(unescape(encodeURIComponent(content))),  // Fix UTF-8 cho JSON tiếng Việt
        branch: "main",
        sha: sha
      })
    });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(`PUT failed: ${res.status} - ${err}`);
    }
    return true;
  } catch (e) {
    console.error("Put error:", e);
    throw e;
  }
}

async function getSha(path) {
  try {
    const r = await fetch(API + "/" + path, {headers: {Authorization: "token " + TOKEN}});
    if (!r.ok) return undefined;
    const j = await r.json();
    return j.sha;
  } catch (e) {
    console.error("Get SHA error:", e);
    return undefined;
  }
}

async function uploadFile(path, file) {
  try {
    const buf = await file.arrayBuffer();
    if (buf.byteLength > 1 * 1024 * 1024) throw new Error("File quá lớn (>1MB, thử nén ảnh)");  // Limit GitHub
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const sha = await getSha(path);
    const res = await fetch(API + "/" + path, {
      method: "PUT",
      headers: {Authorization: "token " + TOKEN, "Content-Type": "application/json"},
      body: JSON.stringify({
        message: "upload ảnh",
        content: base64,
        branch: "main",
        sha: sha
      })
    });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(`Upload file failed: ${res.status} - ${err}`);
    }
    return "https://raw.githubusercontent.com/" + REPO + "/main/" + path;
  } catch (e) {
    console.error("Upload file error:", e);
    throw e;
  }
}

async function getCurrentStories() {
  try {
    const r = await fetch("https://raw.githubusercontent.com/" + REPO + "/main/stories.json?" + Date.now(), {
      headers: {Authorization: "token " + TOKEN}  // Để fetch raw nếu private, nhưng repo public nên OK
    });
    if (!r.ok) {
      if (r.status === 404) {
        console.log("stories.json không tồn tại, tạo mới");
        return [];
      }
      throw new Error(`Fetch stories failed: ${r.status}`);
    }
    return await r.json();
  } catch (e) {
    console.error("Get stories error:", e);
    return [];  // Fallback: tạo mới nếu fail
  }
}

async function start() {
  const log = document.getElementById("log");
  const fill = document.getElementById("fill");
  try {
    log.textContent = "Bắt đầu..."; fill.style.width = "0%";

    const title = document.getElementById("title").value.trim();
    const id = document.getElementById("id").value.trim();
    if (!title || !id) return alert("Nhập tên truyện và ID!");

    const coverFile = document.getElementById("cover").files[0];
    if (!coverFile) return alert("Chọn ảnh bìa!");

    const files = document.getElementById("imgs").files;
    if (!files.length) return alert("Chọn ảnh chapter!");

    const author = document.getElementById("author").value.trim() || "Đang cập nhật";
    const chap = document.getElementById("chap").value.replace(/[^a-z0-9]/gi, '_');

    // 1. Upload ảnh bìa
    log.textContent = "Upload ảnh bìa..."; fill.style.width = "10%";
    const cover = await uploadFile(`images/${id}_cover.jpg`, coverFile);

    // 2. Upload ảnh chapter
    const urls = [];
    for (let i = 0; i < files.length; i++) {
      log.textContent = `Upload ảnh ${i+1}/${files.length}...`;
      const url = await uploadFile(`images/${id}_${chap}_${i+1}.jpg`, files[i]);
      urls.push(url);
      fill.style.width = 10 + 80 * (i + 1) / files.length + "%";
    }

    // 3. Cập nhật stories.json
    log.textContent = "Cập nhật stories.json..."; fill.style.width = "95%";
    const current = await getCurrentStories();
    const existingIdx = current.findIndex(s => s.id === id);
    const newChapter = { name: document.getElementById("chap").value, images: urls };
    let story;
    if (existingIdx >= 0) {
      current[existingIdx].chapters.push(newChapter);
      story = current[existingIdx];
    } else {
      story = {
        id,
        title,
        author,
        thumbnail: cover,
        chapters: [newChapter]
      };
      current.push(story);
    }
    await put("stories.json", JSON.stringify(current, null, 2));

    fill.style.width = "100%";
    log.innerHTML = "<b style='color:green;font-size:1.3em'>HOÀN TẤT 100%!</b><br>Reload trang chủ để thấy truyện mới!";
  } catch (e) {
    console.error("Start error:", e);
    log.innerHTML = `<b style='color:red'>LỖI: ${e.message}</b><br>Kiểm tra console (F12) để debug.`;
    fill.style.width = "0%";
  }
}

// Drag & drop
document.getElementById("drop").onclick = () => document.getElementById("imgs").click();
document.getElementById("drop").ondragover = e => e.preventDefault();
document.getElementById("drop").ondrop = e => {
  e.preventDefault();
  document.getElementById("imgs").files = e.dataTransfer.files;
  document.getElementById("drop").innerHTML = `Đã chọn <b>${e.dataTransfer.files.length}</b> ảnh`;
};
    </script>
