<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ƒêƒÉng Truy·ªán - Coconut Manga</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding: 25px;
}

.container {
  max-width: 650px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
}

h1 {
  margin: 0 0 20px;
  text-align: center;
  color: #e74c3c;
  font-size: 28px;
  font-weight: 700;
}

input, textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 10px;
  margin: 10px 0;
  font-size: 16px;
}

textarea { height: 100px; resize: vertical; }

#dropZone {
  border: 3px dashed #e74c3c;
  padding: 35px;
  border-radius: 12px;
  text-align: center;
  color: #555;
  background: #fff7f7;
  cursor: pointer;
  transition: .3s;
}
#dropZone:hover { background: #ffeaea; }

button {
  width: 100%;
  padding: 15px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
  margin-top: 10px;
  font-weight: bold;
  transition: .2s;
}
button:hover { opacity: 0.88; }

.progress {
  width: 100%;
  height: 12px;
  background: #eee;
  border-radius: 6px;
  margin-top: 20px;
  overflow: hidden;
}
.bar {
  height: 100%;
  width: 0%;
  background: #e74c3c;
  transition: width .4s;
}

#log {
  margin-top: 20px;
  padding: 15px;
  background: #222;
  color: #0f0;
  font-size: 14px;
  height: 180px;
  overflow-y: auto;
  border-radius: 10px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<div class="container">
  <h1>ƒêƒÇNG TRUY·ªÜN</h1>

  <input id="title" placeholder="T√™n truy·ªán (b·∫Øt bu·ªôc)">
  <input id="id" placeholder="ID truy·ªán (kh√¥ng d·∫•u)">
  <input id="author" placeholder="T√°c gi·∫£">
  <textarea id="description" placeholder="M√¥ t·∫£ truy·ªán..."></textarea>

  <label><b>·∫¢nh b√¨a (ch·ªâ c·∫ßn khi th√™m truy·ªán m·ªõi):</b></label>
  <input type="file" id="cover" accept="image/*">

  <input id="chapName" placeholder="T√™n chapter (vd: Chapter 3)">

  <div id="dropZone">K√©o ·∫£nh chapter v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</div>
  <input type="file" id="chapterImages" multiple accept="image/*" style="display:none">

  <button onclick="upload()">ƒêƒÇNG TRUY·ªÜN</button>

  <div class="progress"><div class="bar" id="bar"></div></div>

  <div id="log"></div>
</div>

<script>
function log(msg) {
  const box = document.getElementById("log");
  box.textContent += msg + "\n";
  box.scrollTop = box.scrollHeight;
}

document.getElementById("dropZone").onclick = () =>
  document.getElementById("chapterImages").click();

document.getElementById("chapterImages").onchange = (e) => {
  log("ƒê√£ ch·ªçn " + e.target.files.length + " ·∫£nh chapter");
};

// =========================================
// N√âN ·∫¢NH
// =========================================
function resizeImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);

    img.onload = () => {
      const canvas = document.createElement("canvas");
      let w = img.width, h = img.height;
      const MAX = 1600;

      if (w > MAX) { h *= MAX / w; w = MAX; }
      if (h > MAX) { w *= MAX / h; h = MAX; }

      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);

      resolve(canvas.toDataURL("image/jpeg", 0.85).split(",")[1]);
    };
  });
}

// =========================================
// UPLOAD FILE
// =========================================
async function uploadFile(token, path, base64) {
  log("‚¨Ü Upload: " + path);

  const api = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents/";
  const raw = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/";

  const check = await fetch(api + path, {
    headers: { Authorization: "token " + token }
  });

  const payload = {
    message: "upload file",
    content: base64,
    branch: "main"
  };

  if (check.ok) {
    const sha = (await check.json()).sha;
    payload.sha = sha;
    log("‚Ä¢ Update file (ƒë√£ t·ªìn t·∫°i)");
  }

  const res = await fetch(api + path, {
    method: "PUT",
    headers: {
      Authorization: "token " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    let err = await res.json();
    log("‚ùå Upload l·ªói: " + JSON.stringify(err));
    throw err.message;
  }

  return raw + path;
}

// =========================================
// UPLOAD CH√çNH
// =========================================
async function upload() {
  const bar = document.getElementById("bar");
  const id = document.getElementById("id").value.trim().toLowerCase();
  const title = document.getElementById("title").value.trim();
  const chapName = document.getElementById("chapName").value.trim();
  const files = document.getElementById("chapterImages").files;

  document.getElementById("log").textContent = "";

  if (!id || !title) return log("‚ö† Thi·∫øu ID ho·∫∑c t√™n truy·ªán");
  if (!chapName) return log("‚ö† Thi·∫øu t√™n chapter");
  if (!files.length) return log("‚ö† Ch∆∞a ch·ªçn ·∫£nh chapter");

  const token = prompt("Nh·∫≠p GitHub Token (ghp_...)");
  if (!token || !token.startsWith("ghp_")) return log("‚ùå Token kh√¥ng h·ª£p l·ªá");

  try {
    log("===== B·∫Øt ƒë·∫ßu upload =====");

    // =====================================
    // 1. Upload cover n·∫øu c√≥
    // =====================================
    let coverUrl = "";
    const cover = document.getElementById("cover").files[0];
    if (cover) {
      log("N√©n ·∫£nh b√¨a...");
      const base64 = await resizeImage(cover);
      coverUrl = await uploadFile(token, `images/${id}_cover.jpg`, base64);
    }

    // =====================================
    // 2. Upload ·∫£nh chapter
    // =====================================
    let imgs = [];
    for (let i = 0; i < files.length; i++) {
      log(`N√©n ·∫£nh ${i+1}/${files.length}`);
      const base64 = await resizeImage(files[i]);
      const url = await uploadFile(token, `images/${id}_${Date.now()}_${i+1}.jpg`, base64);
      imgs.push(url);

      bar.style.width = (i / files.length) * 80 + "%";
    }

    // =====================================
    // 3. Update stories.json
    // =====================================
    log("T·∫£i stories.json...");
    const jsonUrl = `https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/stories.json?t=${Date.now()}`;
    const stories = await fetch(jsonUrl).then(r => r.json());

    let story = stories.find(s => s.id === id);
    if (!story) {
      log("‚Üí Truy·ªán m·ªõi, t·∫°o m·ªõi.");
      story = {
        id, title,
        author: document.getElementById("author").value || "Kh√¥ng r√µ",
        description: document.getElementById("description").value || "",
        thumbnail: coverUrl,
        chapters: []
      };
      stories.push(story);
    }

    story.chapters.push({
      name: chapName,
      images: imgs
    });

    log("Upload stories.json...");
    const json64 = btoa(unescape(encodeURIComponent(JSON.stringify(stories, null, 2))));
    await uploadFile(token, "stories.json", json64);

    bar.style.width = "100%";
    log("üéâ HO√ÄN T·∫§T 100%!");

  } catch (err) {
    log("‚ùå L·ªñI CU·ªêI: " + err);
  }
}
</script>

</body>
</html>
