<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Truyện - Coconut Manga</title>
    <style>
        body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:20px;min-height:100vh}
        .box{max-width:600px;margin:20px auto;background:#fff;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.3);overflow:hidden}
        header{background:linear-gradient(45deg,#e74c3c,#c0392b);color:#fff;text-align:center;padding:30px}
        h1{margin:0;font-size:2.2em}
        .form{padding:25px}
        label{display:block;margin:15px 0 8px;font-weight:bold;color:#333}
        input[type=text],input[type=file]{width:100%;padding:14px;border:2px solid #ddd;border-radius:12px;font-size:16px;box-sizing:border-box}
        input:focus{border-color:#e74c3c;outline:none}
        .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:50px;text-align:center;border-radius:15px;margin:20px 0;cursor:pointer}
        .drop:hover{background:#ffeaea}
        button{width:100%;padding:18px;background:#e74c3c;color:#fff;border:none;border-radius:12px;font-size:1.3em;font-weight:bold;cursor:pointer;margin-top:20px;box-shadow:0 8px 20px rgba(231,76,60,0.4)}
        button:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(231,76,60,0.5)}
        .progress{height:12px;background:#f0f0f0;border-radius:6px;overflow:hidden;margin:20px 0}
        .bar{height:100%;width:0;background:#e74c3c;transition:width .4s}
        #status{text-align:center;padding:15px;font-weight:bold;font-size:1.1em;min-height:50px}
        .ok{color:#27ae60}
        .err{color:#e74c3c}
    </style>
</head>
<body>
<div class="box">
    <header><h1>ĐĂNG TRUYỆN MỚI</h1></header>
    <div class="form">
        <label>Tên truyện *</label>
        <input type="text" id="title" placeholder="Ví dụ: Ta Vô Địch Lúc Nào" required>

        <label>ID truyện (không dấu, viết thường) *</label>
        <input type="text" id="id" placeholder="Ví dụ: tavodichlucnao" required>

        <label>Tác giả (không bắt buộc)</label>
        <input type="text" id="author" placeholder="Không bắt buộc">

        <label>Ảnh bìa *</label>
        <input type="file" id="cover" accept="image/*" required>

        <label>Tên chapter</label>
        <input type="text" id="chap" value="Chapter 1">

        <label>Ảnh các trang chapter *</label>
        <div class="drop" id="drop">Kéo thả ảnh vào đây<br>hoặc nhấn để chọn</div>
        <input type="file" id="imgs" multiple accept="image/*" style="display:none">

        <button onclick="upload()">GỬI TRUYỆN</button>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div id="status">Sẵn sàng</div>
    </div>
</div>

<script>
// Token
let TOKEN = localStorage.getItem("gh_token");
if (!TOKEN || !TOKEN.startsWith("ghp_")) {
    TOKEN = prompt("Nhập GitHub Token (ghp_...)");
    if (TOKEN && TOKEN.startsWith("ghp_")) localStorage.setItem("gh_token", TOKEN);
    else { alert("Token sai!"); throw ""; }
}
const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";

// Lấy SHA
async function getSha(path) {
    const res = await fetch(API + "/" + path, {headers: {Authorization: "token " + TOKEN}});
    if (res.ok) {
        const data = await res.json();
        return data.sha;
    }
    return null;
}

// Upload ảnh
async function uploadImg(path, file) {
    if (file.size > 10*1024*1024) throw "Ảnh quá lớn (>10MB)";
    const buf = await file.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const sha = await getSha(path);
    const res = await fetch(API + "/" + path, {
        method: "PUT",
        headers: {Authorization: "token " + TOKEN, "Content-Type": "application/json"},
        body: JSON.stringify({message: "upload ảnh", content: base64, branch: "main", sha: sha})
    });
    if (!res.ok) throw "Lỗi upload ảnh";
    return "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/" + path;
}

// Lấy + lưu stories.json
async function getStories() {
    const res = await fetch("https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/stories.json?t=" + Date.now());
    if (res.status === 404) return [];
    return await res.json();
}
async function saveStories(data) {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const sha = await getSha("stories.json");
    await fetch(API + "/stories.json", {
        method: "PUT",
        headers: {Authorization: "token " + TOKEN, "Content-Type": "application/json"},
        body: JSON.stringify({message: "update stories", content: content, branch: "main", sha: sha})
    });
}

// Hàm chính
async function upload() {
    const status = document.getElementById("status");
    const bar = document.getElementById("bar");
    try {
        status.textContent = "Đang xử lý...";
        bar.style.width = "5%";

        const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g, "");
        const title = document.getElementById("title").value.trim();
        if (!title || !id) throw "Nhập tên truyện và ID!";
        if (!document.getElementById("cover").files[0]) throw "Chọn ảnh bìa!";
        if (document.getElementById("imgs").files.length === 0) throw "Chọn ảnh chapter!";

        // Upload bìa
        status.textContent = "Upload ảnh bìa...";
        bar.style.width = "20%";
        const cover = await uploadImg("images/" + id + "_cover.jpg", document.getElementById("cover").files[0]);

        // Upload chapter
        const files = document.getElementById("imgs").files;
        const urls = [];
        for (let i = 0; i < files.length; i++) {
            status.textContent = `Upload trang ${i+1}/${files.length}...`;
            bar.style.width = 20 + 70*(i+1)/files.length + "%";
            urls.push(await uploadImg("images/" + id + "_p" + (i+1) + ".jpg", files[i]));
        }

        // Cập nhật stories.json
        status.textContent = "Cập nhật danh sách...";
        bar.style.width = "95%";
        const list = await getStories();
        const exist = list.find(x => x.id === id);
        const chap = {name: document.getElementById("chap").value || "Chapter mới", images: urls};
        if (exist) exist.chapters.push(chap);
        else list.push({id, title, author: document.getElementById("author").value || "Không rõ", thumbnail: cover, chapters: [chap]});
        await saveStories(list);

        bar.style.width = "100%";
        status.innerHTML = "<span class='ok'>HOÀN TẤT! Truyện đã đăng thành công<br>Reload trang chủ là thấy ngay!</span>";
    } catch (e) {
        status.innerHTML = "<span class='err'>LỖI: " + e + "</span>";
        bar.style.width = "0%";
    }
}

// Drag & drop
document.getElementById("drop").onclick = () => document.getElementById("imgs").click();
document.getElementById("drop").ondrop = e => {
    e.preventDefault();
    document.getElementById("imgs").files = e.dataTransfer.files;
    document.getElementById("drop").innerHTML = "Đã chọn <b>" + e.dataTransfer.files.length + "</b> ảnh";
};
document.getElementById("drop").ondragover = e => e.preventDefault();
</script>
</body>
</html>
