<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Đăng Truyện</title>
<style>
  body{font-family:Arial;background:#f1f1f1;padding:20px}
  .box{max-width:650px;margin:auto;background:white;padding:30px;border-radius:15px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
  input,button{padding:12px;margin:10px 0;width:100%;border-radius:8px;border:1px solid #ddd}
  button{background:#e74c3c;color:white;font-size:1.2em;cursor:pointer}
  .drop{border:3px dashed #e74c3c;padding:50px;text-align:center;border-radius:12px;transition:.3s}
  #bar{width:100%;height:25px;background:#ddd;border-radius:12px;overflow:hidden;margin:15px 0}
  #fill{width:0%;height:100%;background:#e74c3c;transition:width .4s}
  #log{font-weight:bold;color:#e74c3c;text-align:center}
</style>
</head>
<body>
<div class="box">
  <h1 style="text-align:center;color:#e74c3c">ĐĂNG TRUYỆN</h1>
  <input type="text" id="title" placeholder="Tên truyện" required>
  <input type="text" id="author" placeholder="Tác giả (không bắt buộc)">
  <input type="text" id="id" placeholder="ID truyện (không dấu, vd: onepiece)" required>
  <input type="file" id="cover" accept="image/*" required>
  <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
  <div class="drop" id="drop">Kéo thả ảnh chapter vào đây</div>
  <input type="file" id="imgs" multiple accept="image/*" style="display:none">
  <button onclick="start()">GỬI NGAY</button>
  <div id="bar"><div id="fill"></div></div>
  <div id="log">Sẵn sàng</div>
</div>

<script>
// Token được lưu trong trình duyệt, không lộ trên GitHub
let TOKEN = localStorage.getItem("gh_token");
if (!TOKEN) {
  TOKEN = prompt("Nhập GitHub Token (ghp_...) – chỉ hiện 1 lần:");
  if (TOKEN && TOKEN.startsWith("ghp_")) localStorage.setItem("gh_token", TOKEN);
  else { alert("Token sai!"); throw "Stop"; }
}

const REPO = "pro-coconut/pro-coconut.github.io";
const API = "https://api.github.com/repos/" + REPO + "/contents";

async function put(path, content) {
  const res = await fetch(API + "/" + path, {
    method: "PUT",
    headers: {Authorization: "token " + TOKEN, "Content-Type": "application/json"},
    body: JSON.stringify({message: "upload", content: btoa(content), branch: "main", sha: await getSha(path)})
  });
  return res.ok;
}
async function getSha(path) {
  try {
    const r = await fetch(API + "/" + path);
    const j = await r.json();
    return j.sha;
  } catch { return undefined; }
}
async function uploadFile(path, file) {
  const buf = await file.arrayBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
  await fetch(API + "/" + path, {
    method: "PUT",
    headers: {Authorization: "token " + TOKEN},
    body: JSON.stringify({message: "upload ảnh", content: base64, branch: "main", sha: await getSha(path)})
  });
  return "https://raw.githubusercontent.com/" + REPO + "/main/" + path;
}

async function start() {
  const log = document.getElementById("log");
  const fill = document.getElementById("fill");
  log.textContent = "Bắt đầu..."; fill.style.width = "0%";

  const id = document.getElementById("id").value.trim();
  if (!id) return alert("Nhập ID!");

  // 1. Ảnh bìa
  log.textContent = "Upload ảnh bìa..."; fill.style.width = "10%";
  const cover = await uploadFile(`images/${id}_cover.jpg`, document.getElementById("cover").files[0]);

  // 2. Ảnh chapter
  const files = document.getElementById("imgs").files;
  if (!files.length) return alert("Chọn ảnh chapter!");
  const chap = document.getElementById("chap").value.replace(/[^a-z0-9]/gi,'_');
  const urls = [];
  for (let i = 0; i < files.length; i++) {
    log.textContent = `Upload ảnh ${i+1}/${files.length}...`;
    const url = await uploadFile(`images/${id}_${chap}_${i+1}.jpg`, files[i]);
    urls.push(url);
    fill.style.width = 10 + 80*(i+1)/files.length + "%";
  }

  // 3. Cập nhật stories.json
  log.textContent = "Cập nhật stories.json..."; fill.style.width = "95%";
  const story = {id, title: document.getElementById("title").value, author: document.getElementById("author").value || "Đang cập nhật", thumbnail: cover, chapters: [{name: document.getElementById("chap").value, images: urls}]};
  const current = await (await fetch("stories.json?"+Date.now())).json();
  const idx = current.findIndex(s=>s.id===id);
  if (idx>=0) current[idx].chapters.push(story.chapters[0]);
  else current.push(story);
  await put("stories.json", JSON.stringify(current,null,2));

  fill.style.width = "100%";
  log.innerHTML = "<b style='color:green;font-size:1.3em'>HOÀN TẤT 100%!</b><br>Reload trang chủ là thấy truyện!";
}

// Drag & drop
document.getElementById("drop").onclick = () => document.getElementById("imgs").click();
document.getElementById("drop").ondragover = e => e.preventDefault();
document.getElementById("drop").ondrop = e => {e.preventDefault(); document.getElementById("imgs").files = e.dataTransfer.files;
  document.getElementById("drop").innerHTML = `Đã chọn <b>${e.dataTransfer.files.length}</b> ảnh`;
};
</script>
</body></html>
