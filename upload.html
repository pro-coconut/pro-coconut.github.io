<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>

<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 15px; }
.box { max-width: 560px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); overflow: hidden; }
h1 { background: #e74c3c; color: #fff; text-align: center; padding: 20px; margin: 0; font-size: 24px; }
.form { padding: 20px; }
input[type=text], input[type=file], textarea {
  width: 100%; padding: 12px; margin: 10px 0;
  border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
}
textarea { height: 100px; resize: vertical; }
.drop {
  border: 3px dashed #e74c3c; background: #fff8f8;
  padding: 40px; text-align: center; border-radius: 12px;
  margin: 15px 0; cursor: pointer; font-size: 16px;
}
.drop:hover { background: #ffe5e5; }
button {
  width: 100%; padding: 15px; background: #e74c3c; color: #fff;
  border: none; border-radius: 10px; font-size: 18px; margin-top: 10px;
  cursor: pointer; font-weight: bold;
}
.progress { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 15px 0; }
.bar { height: 100%; width: 0; background: #e74c3c; transition: width .4s; }
#status { text-align: center; padding: 10px; font-weight: bold; font-size: 16px; }
</style>

</head>
<body>

<div class="box">
  <h1>ĐĂNG TRUYỆN MỚI</h1>
  <div class="form">

    <input type="text" id="title" placeholder="Tên truyện (bắt buộc)">
    <input type="text" id="id" placeholder="ID (không dấu, vd: tavodich)">
    <input type="text" id="author" placeholder="Tác giả">
    <textarea id="description" placeholder="Tóm tắt truyện"></textarea>

    <label><b>Ảnh bìa (chỉ cần nếu truyện mới):</b></label>
    <input type="file" id="cover" accept="image/*">

    <input type="text" id="chap" value="Chapter 1">
    
    <div class="drop" id="dropZone">Kéo thả ảnh chapter vào đây<br>hoặc nhấn để chọn nhiều ảnh</div>
    <input type="file" id="chapterImages" multiple accept="image/*" style="display:none">

    <button onclick="uploadAll()">GỬI TRUYỆN</button>

    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div id="status">Sẵn sàng đăng truyện</div>
  </div>
</div>

<script>
// ======================= TOKEN ===========================
let token = localStorage.getItem("gh_token");
if (!token || !token.startsWith("ghp_")) {
  token = prompt("Nhập GitHub Token (ghp_...):");
  if (token?.startsWith("ghp_")) localStorage.setItem("gh_token", token);
  else { alert("Token sai!"); throw new Error("Token sai"); }
}

const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
const RAW = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

// ======================= RESIZE ẢNH ===========================
function resizeImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => {
      img.src = e.target.result;
    };

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const MAX = 1600;
      let w = img.width, h = img.height;

      if (w > MAX) { h *= MAX / w; w = MAX; }
      if (h > MAX) { w *= MAX / h; h = MAX; }

      canvas.width = w; canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      resolve(canvas.toDataURL("image/jpeg", 0.85).split(",")[1]);
    };

    reader.readAsDataURL(file);
  });
}

// ======================= UPLOAD FILE ===========================
async function uploadFile(path, base64) {
  const payload = { message: "upload file", content: base64, branch: "main" };

  // lấy SHA nếu file đã tồn tại
  const exist = await fetch(API + "/" + path, { headers: { Authorization: "token " + token } });
  if (exist.ok) payload.sha = (await exist.json()).sha;

  const res = await fetch(API + "/" + path, {
    method: "PUT",
    headers: { Authorization: "token " + token, "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const err = await res.json();
    throw (err.message || "Lỗi GitHub API");
  }

  return RAW + "/" + path;
}

// ======================= DRAG / DROP ===========================
const dropZone = document.getElementById("dropZone");
dropZone.onclick = () => document.getElementById("chapterImages").click();
dropZone.ondragover = e => e.preventDefault();
dropZone.ondrop = e => {
  e.preventDefault();
  document.getElementById("chapterImages").files = e.dataTransfer.files;
  dropZone.innerHTML = `<b>Đã chọn ${e.dataTransfer.files.length} ảnh</b>`;
};

document.getElementById("chapterImages").onchange = () => {
  const count = document.getElementById("chapterImages").files.length;
  dropZone.innerHTML = `<b>Đã chọn ${count} ảnh</b>`;
};

// ======================= UPLOAD ALL ===========================
async function uploadAll() {
  const status = document.getElementById("status");
  const bar = document.getElementById("progressBar");

  try {
    status.textContent = "Đang xử lý...";
    bar.style.width = "5%";

    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g, "");
    const title = document.getElementById("title").value.trim();
    if (!id || !title) throw "Thiếu tên truyện hoặc ID";

    // --- UPLOAD COVER ---
    let coverUrl = "";
    const coverFile = document.getElementById("cover").files[0];
    if (coverFile) {
      status.textContent = "Đang nén ảnh bìa...";
      const base64 = await resizeImage(coverFile);
      status.textContent = "Upload ảnh bìa...";
      bar.style.width = "20%";
      coverUrl = await uploadFile(`images/${id}_cover.jpg`, base64);
    }

    // --- UPLOAD CHAPTER IMAGES ---
    const files = document.getElementById("chapterImages").files;
    if (files.length === 0) throw "Chưa chọn ảnh chapter";

    const imageUrls = [];
    for (let i = 0; i < files.length; i++) {
      status.textContent = `Nén ảnh ${i + 1}/${files.length}...`;
      const base64 = await resizeImage(files[i]);

      status.textContent = `Upload ảnh ${i + 1}/${files.length}...`;
      const url = await uploadFile(`images/${id}_p${i + 1}.jpg`, base64);

      imageUrls.push(url);
      bar.style.width = `${20 + (i + 1) / files.length * 70}%`;
    }

    // --- UPDATE stories.json ---
    status.textContent = "Cập nhật stories.json...";
    bar.style.width = "95%";

    const stories = await fetch(RAW + "/stories.json?t=" + Date.now()).then(r => r.json());

    const exist = stories.find(s => s.id === id);
    const newChap = {
      name: document.getElementById("chap").value || "Chapter mới",
      images: imageUrls
    };

    if (exist) {
      exist.chapters.push(newChap);
    } else {
      stories.push({
        id,
        title,
        author: document.getElementById("author").value || "Không rõ",
        description: document.getElementById("description").value || "",
        thumbnail: coverUrl,
        chapters: [newChap]
      });
    }

    const jsonBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(stories, null, 2))));
    await uploadFile("stories.json", jsonBase64);

    bar.style.width = "100%";
    status.innerHTML = "<b style='color:green'>✔ Thành công 100%! Reload trang chủ để xem.</b>";

  } catch (e) {
    status.innerHTML = "<b style='color:red'>Lỗi: " + e + "</b>";
    bar.style.width = "0";
  }
}
</script>

</body>
</html>
